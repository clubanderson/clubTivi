# Weekly release â€” runs every Sunday at 6:00 AM UTC
name: Weekly Release

on:
  schedule:
    - cron: '0 6 * * 0'
  workflow_dispatch: # allow manual trigger

concurrency:
  group: weekly-release
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare release tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      name: ${{ steps.tag.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate weekly tag
        id: tag
        run: |
          WEEK=$(date -u '+%Y.%W')
          echo "tag=weekly-${WEEK}" >> "$GITHUB_OUTPUT"
          echo "name=ðŸ“¦ Weekly ${WEEK}" >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      release_tag: ${{ needs.prepare.outputs.tag }}
      release_name: ${{ needs.prepare.outputs.name }}
      prerelease: false

  cleanup:
    name: Clean up old weeklies
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Delete old weekly releases (keep last 8)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName,isPrerelease \
            -q '[.[] | select(.isPrerelease == false and (.tagName | startswith("weekly-")))] | sort_by(.tagName) | reverse | .[8:][] | .tagName' \
          | while read -r tag; do
              echo "Deleting old weekly: $tag"
              gh release delete "$tag" --yes --cleanup-tag
            done
